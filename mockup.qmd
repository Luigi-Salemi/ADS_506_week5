---
title: "Australian Wine Sales Forecasting - Requirements Document"
format: html
editor: visual
---

## Setup

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(fpp3)
library(gt)
library(urca)

# Set theme for plots
theme_set(theme_minimal())
```

## Load and Wrangle Data

```{r load-data}
# Load the data
wine_raw <- read_csv("AustralianWines.csv", show_col_types = FALSE)

# Inspect structure
head(wine_raw)

# Convert to long format and create tsibble
wine_data <- wine_raw %>%
  # Parse the Month column to yearmonth
  mutate(Month = yearmonth(parse_date_time(Month, "my"))) %>%
  # Convert all columns except Month to numeric (handles "*" and other non-numeric values)
  mutate(across(-Month, ~as.numeric(as.character(.)))) %>%
  # Pivot to long format
  pivot_longer(
    cols = -Month,
    names_to = "Varietal",
    values_to = "Sales"
  ) %>%
  # Clean varietal names (remove trailing spaces)
  mutate(Varietal = str_trim(Varietal)) %>%
  # Remove any rows with missing sales values
  filter(!is.na(Sales)) %>%
  # Convert to tsibble
  as_tsibble(key = Varietal, index = Month)

# Display the tsibble
wine_data

# Summary statistics by varietal
wine_data %>%
  group_by(Varietal) %>%
  summarise(
    n = n(),
    mean_sales = mean(Sales),
    sd_sales = sd(Sales),
    min_sales = min(Sales),
    max_sales = max(Sales)
  ) %>%
  gt() %>%
  fmt_number(columns = c(mean_sales, sd_sales, min_sales, max_sales), decimals = 1)
```

## Visualization Logic

### Time Series Plot with Faceting

```{r viz-faceted}
# Define date range for filtering
train_start <- yearmonth("1980 Jan")
cutoff_date <- yearmonth("1993 Jan")

# Filter data for selected varietals and date range
selected_varietals <- c("Red", "Dry white", "sparkling")

wine_filtered <- wine_data %>%
  filter(
    Varietal %in% selected_varietals,
    Month >= train_start,
    Month <= cutoff_date
  )

# Create faceted plot with free y-scales
wine_filtered %>%
  autoplot(Sales) +
  facet_wrap(~Varietal, scales = "free_y", ncol = 1) +
  labs(
    title = "Australian Wine Sales by Varietal",
    subtitle = paste("Training period:", train_start, "to", cutoff_date),
    x = "Month",
    y = "Sales (thousands of liters)"
  ) +
  theme(legend.position = "none")
```

### Seasonality and Decomposition

```{r viz-seasonal}
# STL decomposition for selected varietals
wine_filtered %>%
  model(STL(Sales ~ season(window = "periodic"))) %>%
  components() %>%
  autoplot() +
  facet_wrap(~Varietal, scales = "free_y", ncol = 1) +
  labs(title = "STL Decomposition by Varietal")
```

## Model Building Logic

### Define Train/Test Split

```{r train-test-split}
# Define forecast horizon
forecast_horizon <- 12  # 12 months

# Create training and validation sets
train_end <- yearmonth("1992 Dec")
validation_start <- yearmonth("1993 Jan")
validation_end <- yearmonth("1993 Dec")

wine_train <- wine_data %>%
  filter(
    Varietal %in% selected_varietals,
    Month >= train_start,
    Month <= train_end
  )

wine_validation <- wine_data %>%
  filter(
    Varietal %in% selected_varietals,
    Month >= validation_start,
    Month <= validation_end
  )
```

### Fit Models (TSLM, ETS, ARIMA)

```{r fit-models}
# Fit multiple models per varietal
wine_models <- wine_train %>%
  model(
    TSLM = TSLM(Sales ~ trend() + season()),
    ETS = ETS(Sales),
    ARIMA = ARIMA(Sales)
  )

# Display model specifications
wine_models
```

### Extract Model Specifications

```{r model-specs}
# Extract model specifications using glance
model_specs <- wine_models %>%
  pivot_longer(
    cols = c(TSLM, ETS, ARIMA),
    names_to = "Model",
    values_to = "Fit"
  ) %>%
  mutate(Specification = format(Fit)) %>%
  as_tibble() %>%
  select(Varietal, Model, Specification)

model_specs %>%
  gt() %>%
  tab_header(title = "Model Specifications by Varietal")
```

### Calculate Training Accuracy

```{r training-accuracy}
# Calculate accuracy on training data
train_accuracy <- wine_models %>%
  accuracy() %>%
  select(Varietal, .model, RMSE, MAE, MAPE) %>%
  arrange(Varietal, .model)

train_accuracy %>%
  gt() %>%
  tab_header(title = "Training Accuracy Metrics") %>%
  fmt_number(columns = c(RMSE, MAE, MAPE), decimals = 2)
```

### Generate Forecasts

```{r generate-forecasts}
# Generate forecasts for the validation period
wine_forecasts <- wine_models %>%
  forecast(h = forecast_horizon)

# Display forecast summary
wine_forecasts
```

### Calculate Validation Accuracy

```{r validation-accuracy}
# Calculate accuracy on validation data
validation_accuracy <- wine_forecasts %>%
  accuracy(wine_validation) %>%
  select(Varietal, .model, RMSE, MAE, MAPE) %>%
  arrange(Varietal, .model)

validation_accuracy %>%
  gt() %>%
  tab_header(title = "Validation Accuracy Metrics") %>%
  fmt_number(columns = c(RMSE, MAE, MAPE), decimals = 2)
```

### Combined Accuracy Table

```{r combined-accuracy}
# Combine training and validation accuracy
combined_accuracy <- train_accuracy %>%
  rename(
    RMSE_train = RMSE,
    MAE_train = MAE,
    MAPE_train = MAPE
  ) %>%
  left_join(
    validation_accuracy %>%
      rename(
        RMSE_val = RMSE,
        MAE_val = MAE,
        MAPE_val = MAPE
      ),
    by = c("Varietal", ".model")
  )

combined_accuracy %>%
  gt() %>%
  tab_header(title = "Training vs Validation Accuracy") %>%
  fmt_number(columns = c(RMSE_train, MAE_train, MAPE_train,
                         RMSE_val, MAE_val, MAPE_val), decimals = 2) %>%
  tab_spanner(
    label = "Training",
    columns = c(RMSE_train, MAE_train, MAPE_train)
  ) %>%
  tab_spanner(
    label = "Validation",
    columns = c(RMSE_val, MAE_val, MAPE_val)
  )
```

## Forecast Visualization

### Comparative Forecast Plot

```{r forecast-plot}
# Plot forecasts with prediction intervals
wine_forecasts %>%
  autoplot(wine_data %>% filter(Varietal %in% selected_varietals), level = c(80, 95)) +
  facet_wrap(~Varietal, scales = "free_y", ncol = 1) +
  labs(
    title = "Comparative Forecasts by Model",
    subtitle = paste("Forecast horizon:", forecast_horizon, "months"),
    x = "Month",
    y = "Sales (thousands of liters)",
    color = "Model",
    fill = "Prediction Interval"
  ) +
  theme(legend.position = "bottom")
```

### Forecast vs Actuals

```{r forecast-vs-actuals}
# Create a plot showing forecast vs actual values
wine_forecasts %>%
  autoplot(
    wine_data %>%
      filter(
        Varietal %in% selected_varietals,
        Month >= train_start
      ),
    level = 95
  ) +
  facet_grid(Varietal ~ .model, scales = "free_y") +
  labs(
    title = "Forecast vs Actuals by Model and Varietal",
    x = "Month",
    y = "Sales (thousands of liters)"
  ) +
  theme(legend.position = "bottom")
```

## Summary

This document establishes the requirements for the Shiny app:

1. **Data**: Monthly tsibble of Australian wine sales by varietal
2. **Visualization**: Faceted time series plots with free y-scales, optional decomposition
3. **Models**: TSLM, ETS, and ARIMA with auto-specification
4. **Metrics**: RMSE, MAE, MAPE for both training and validation periods
5. **Forecasts**: Comparative forecasts with 80% and 95% prediction intervals
6. **Interactivity**: User controls for varietal selection, date range, and forecast horizon

